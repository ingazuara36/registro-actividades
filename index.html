<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Actividades</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: Raleway, sans-serif; font-size: 11pt; padding: 20px; background: #f4f4f4; }
    h1 { text-align: center; }
    form, .filter-section { margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; }
    label { display: block; margin-top: 10px; }
    input, textarea, select { width: 100%; padding: 8px; margin-top: 5px; font-family: Raleway, sans-serif; font-size: 11pt; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-family: Raleway, sans-serif; font-size: 11pt; }
    th { background-color: #eee; }
    button { margin-top: 15px; padding: 10px 20px; font-family: Raleway, sans-serif; font-size: 11pt; }
    .action-buttons { display: flex; gap: 5px; }
  </style>
</head>
<body>
  <h1>Registro de Actividades Diarias</h1>
  <form id="activity-form">
    <input type="hidden" id="edit-index" />
    <label>Fecha:<input type="date" id="date" required></label>
    <label>Hora de inicio:<input type="time" id="start-time" required></label>
    <label>Hora de fin:<input type="time" id="end-time" required></label>
    <label>Descripción:<textarea id="description" required></textarea></label>
    <label>Categoría:<input type="text" id="category"></label>
    <button type="submit">Guardar actividad</button>
  </form>

  <div class="filter-section">
    <label>Filtrar por fecha:<input type="date" id="filter-date"></label>
    <button onclick="loadActivities()">Aplicar filtro</button>
  </div>

  <h2>Actividades</h2>
  <table id="activity-table">
    <thead>
      <tr><th>Fecha</th><th>Inicio</th><th>Fin</th><th>Descripción</th><th>Categoría</th><th>Acciones</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="downloadExcelReport()">Descargar Reporte con Gráfico</button>

  <script>
    const form = document.getElementById('activity-form');
    const tableBody = document.querySelector('#activity-table tbody');

    function loadActivities() {
      const data = JSON.parse(localStorage.getItem('activities') || '[]');
      const filterDate = document.getElementById('filter-date').value;
      tableBody.innerHTML = '';
      data.forEach((d, i) => {
        if (!filterDate || d.date === filterDate) {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${d.date}</td><td>${d.start}</td><td>${d.end}</td><td>${d.description}</td><td>${d.category}</td>`;
          const actionCell = document.createElement('td');
          actionCell.classList.add('action-buttons');

          const editBtn = document.createElement('button');
          editBtn.textContent = 'Modificar';
          editBtn.onclick = () => editActivity(i);

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Borrar';
          deleteBtn.onclick = () => deleteActivity(i);

          actionCell.appendChild(editBtn);
          actionCell.appendChild(deleteBtn);
          row.appendChild(actionCell);

          tableBody.appendChild(row);
        }
      });
    }

    form.addEventListener('submit', e => {
      e.preventDefault();
      const index = document.getElementById('edit-index').value;
      const activity = {
        date: document.getElementById('date').value,
        start: document.getElementById('start-time').value,
        end: document.getElementById('end-time').value,
        description: document.getElementById('description').value,
        category: document.getElementById('category').value || 'General'
      };
      let data = JSON.parse(localStorage.getItem('activities') || '[]');
      if (index === '') {
        data.push(activity);
      } else {
        data[parseInt(index)] = activity;
      }
      localStorage.setItem('activities', JSON.stringify(data));
      form.reset();
      document.getElementById('edit-index').value = '';
      loadActivities();
    });

    function editActivity(index) {
      const data = JSON.parse(localStorage.getItem('activities') || '[]');
      const a = data[index];
      document.getElementById('date').value = a.date;
      document.getElementById('start-time').value = a.start;
      document.getElementById('end-time').value = a.end;
      document.getElementById('description').value = a.description;
      document.getElementById('category').value = a.category;
      document.getElementById('edit-index').value = index;
    }

    function deleteActivity(index) {
      let data = JSON.parse(localStorage.getItem('activities') || '[]');
      data.splice(index, 1);
      localStorage.setItem('activities', JSON.stringify(data));
      loadActivities();
    }

    function downloadExcelReport() {
      const data = JSON.parse(localStorage.getItem('activities') || '[]');
      if (data.length === 0) return alert("No hay datos para exportar.");

      const sortedData = data.slice().sort((a, b) => new Date(a.date) - new Date(b.date));
      const categoryCount = {};
      sortedData.forEach(row => {
        categoryCount[row.category] = (categoryCount[row.category] || 0) + 1;
      });

      const wb = XLSX.utils.book_new();
      const ws_data = XLSX.utils.json_to_sheet(sortedData);
      XLSX.utils.book_append_sheet(wb, ws_data, "Actividades");

      const summary = Object.entries(categoryCount).map(([cat, count]) => ({ Categoría: cat, Cantidad: count }));
      const ws_summary = XLSX.utils.json_to_sheet(summary);
      XLSX.utils.book_append_sheet(wb, ws_summary, "Resumen");

      XLSX.writeFile(wb, "Reporte_Actividades.xlsx");
    }

    loadActivities();
  </script>
</body>
</html>